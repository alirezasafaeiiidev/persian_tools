# Persian Tools Nginx config (Ubuntu 22.04)
# Place in: /etc/nginx/sites-available/persian-tools.conf
# Enable with: ln -s /etc/nginx/sites-available/persian-tools.conf /etc/nginx/sites-enabled/

upstream persian_tools_production {
  server 127.0.0.1:3000;
  keepalive 32;
}

upstream persian_tools_staging {
  server 127.0.0.1:3001;
  keepalive 16;
}

server {
  listen 80;
  listen [::]:80;
  server_name persiantoolbox.ir www.persiantoolbox.ir;

  # Optional: inject analytics ingest secret server-side so it never ships to the browser.
  # Replace __ANALYTICS_INGEST_SECRET__ with your real secret from /var/www/persian-tools/shared/env/production.env
  location = /api/analytics {
    proxy_pass http://persian_tools_production;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header x-pt-analytics-secret "__ANALYTICS_INGEST_SECRET__";
    proxy_read_timeout 60s;
  }

  location / {
    proxy_pass http://persian_tools_production;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_read_timeout 60s;
  }
}

server {
  listen 80;
  listen [::]:80;
  server_name staging.persiantoolbox.ir;

  # Optional: inject analytics ingest secret server-side (staging)
  location = /api/analytics {
    proxy_pass http://persian_tools_staging;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header x-pt-analytics-secret "__ANALYTICS_INGEST_SECRET__";
    proxy_read_timeout 60s;
  }

  location / {
    proxy_pass http://persian_tools_staging;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_read_timeout 60s;
  }
}
