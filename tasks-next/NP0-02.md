# ID: NP0-02

## Title

Deploy-blocking gate: P0 done + lint/test/build + Lighthouse + security audit

## Status

DONE

## Context

Deployment must be forbidden unless all launch blockers are done and verification passes. Currently CI has multiple workflows (`ci-core.yml`, Lighthouse, security audit), but there is no single “release gate” that also checks the repo’s own task completion policy (P0 done).

## Steps

1. Define a machine-checkable contract for task completion:
   - parse `tasks/*.md` and require `## Status` = `DONE` for all `P0-*`
2. Add a new CI job/workflow (or extend `ci-core.yml`) that is required for deploy:
   - runs `pnpm lint`
   - runs `pnpm test:ci`
   - runs `pnpm build`
   - runs `pnpm lighthouse:ci`
   - runs `pnpm security:scan`
   - runs the “P0 status gate” script
3. Ensure deploy workflows (`deploy-staging.yml`, `deploy-production.yml`) depend on this gate.

## Acceptance Criteria

- A single required check blocks deployment when any condition fails.
- Deploy workflows cannot run (or fail early) if P0 tasks are not DONE.

## Dependencies

- None.

## Files to modify

- `.github/workflows/ci-core.yml`
- `.github/workflows/deploy-staging.yml`
- `.github/workflows/deploy-production.yml`
- `scripts/quality/*` (new P0 status gate)
- `TASKS.md`, `tasks/*` (contract fields)

## Implementation Notes

- Added `scripts/quality/verify-np0-tasks.mjs` and wired `pnpm gate:deploy` to enforce all `tasks-next/NP0-*` have `Status: DONE`.
- Created reusable workflow `.github/workflows/deploy-gate.yml` that runs the deploy gate: NP0 check, lint, test:ci, build, lighthouse:ci, security:scan.
- Updated `deploy-staging.yml` and `deploy-production.yml` to require the `deploy-gate` job before deployment.
- Added package script `gate:deploy` to expose the gate locally/CI.

## Verification

- `pnpm lint` (pass)
- `pnpm test:ci` (pass)
- `pnpm build` (pass)
- `pnpm lighthouse:ci` (pass; perf warnings remain non-blocking per config)
- `pnpm security:scan` (passes with existing low/moderate advisories)
- `pnpm gate:deploy` (fails as expected until NP0-03..NP0-10 are marked DONE)

## Files Changed

- `scripts/quality/verify-np0-tasks.mjs`
- `package.json`
- `.github/workflows/deploy-gate.yml`
- `.github/workflows/deploy-staging.yml`
- `.github/workflows/deploy-production.yml`
