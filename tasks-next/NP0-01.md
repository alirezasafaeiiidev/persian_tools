# ID: NP0-01

## Title

Production-grade analytics storage (no single JSON file)

## Context

Analytics ingestion currently persists an aggregated summary in a single JSON file on disk (`lib/analyticsStore.ts`). At 100k DAU, concurrent writes and burst traffic can cause contention, partial writes, corruption, and I/O load. This is a scale blocker even if analytics is “optional”.

## Steps

1. Define analytics retention and data model:
   - aggregated counters only (no raw events), OR
   - append-only event log + periodic compaction
2. Replace file-based `summary.json` writes with one of:
   - Postgres table (preferred if DB exists), or
   - SQLite WAL mode (if staying local to host), or
   - append-only newline JSON log + periodic compaction (single-host only)
3. Ensure ingestion is safe under concurrency (locking/transactions).
4. Add backpressure/limits:
   - max events per request already exists in `app/api/analytics/route.ts`
   - add server-side rate limits + payload size enforcement
5. Add ops tooling:
   - export/report endpoint behind admin auth
   - log rotation/retention config

## Acceptance Criteria

- No single JSON file is rewritten on every ingest request.
- Ingestion remains same-origin and consent-gated.
- Load test (local harness) shows stable ingestion at target RPS without corruption.

## Dependencies

- If using Postgres: `DATABASE_URL` availability and schema migrations.

## Files to modify

- `lib/analyticsStore.ts`
- `app/api/analytics/route.ts`
- `lib/server/rateLimit.ts`
- `scripts/db/schema.sql` (if DB-backed)
- `docs/technical/*` (ops notes)
